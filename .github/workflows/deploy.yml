name: Deploy voting-app

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /home/ubuntu/voting-app  # absolute path, not ~


    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Ensure Docker daemon is running
        run: |
          if ! docker info &> /dev/null; then
            echo "Docker daemon is not running. Starting..."
            sudo nohup dockerd --host=unix:///var/run/docker.sock --containerd=/run/containerd/containerd.sock > ~/dockerd.log 2>&1 &
            sleep 10
          fi
          docker info

      - name: Deploy voting-app stack
        run: |
          docker compose -f compose.yml -p votingapp up -d

  dockerhub-login:
    name: Login to Docker Hub
    needs: deploy
    runs-on: self-hosted

    steps:
      - name: Login to Docker Hub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          echo "âœ… Successfully logged into Docker Hub!"
